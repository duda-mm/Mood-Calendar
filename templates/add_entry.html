{% extends "base.html" %}
{% block conteudo %}
<style>
    /* Estilo dos Botões de Rádio Coloridos */
    .mood-selector input[type="radio"] { display: none; }
    .mood-selector label {
        display: inline-block; width: 40px; height: 40px; border-radius: 50%;
        margin-right: 10px; cursor: pointer; border: 3px solid transparent;
        transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .mood-selector label:hover { transform: scale(1.1); }
    .mood-selector input[type="radio"]:checked + label { border-color: #4A403A; transform: scale(1.2); }
    
    /* Preview da Capa */
    #album-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
</style>

<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="custom-card">
            <h4 class="mb-4 fw-bold" style="font-family: 'Lora', serif;">
                {% if editando %}✏️ Reescrever Memória{% else %}✍️ Nova Página{% endif %}
            </h4>
            
            <form method="POST">
                <div class="mb-4">
                    <label class="form-label fw-bold text-muted small">TÍTULO DA MEMÓRIA</label>
                    <input type="text" name="titulo" class="form-control" 
                        placeholder="Como você resume o dia de hoje?" 
                        value="{{ entrada.titulo if entrada and entrada.titulo else '' }}">
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">DATA</label>
                        <input type="date" name="data" class="form-control" required value="{{ entrada.data_registro if editando else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-muted">NOTA (1-5)</label>
                        <input type="range" name="nota" class="form-range" min="1" max="5" value="{{ entrada.nota_dia if editando else 3 }}">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted d-block">SENTIMENTO</label>
                    <div class="mood-selector d-flex align-items-center flex-wrap gap-2">
                        <input type="radio" name="humor_cor" id="m1" value="muito-feliz" {% if editando and entrada.humor_cor == 'muito-feliz' %}checked{% endif %} required>
                        <label for="m1" style="background-color: var(--mood-muito-feliz);" title="Muito Feliz"></label>
                        <input type="radio" name="humor_cor" id="m2" value="satisfeito" {% if editando and entrada.humor_cor == 'satisfeito' %}checked{% endif %}>
                        <label for="m2" style="background-color: var(--mood-satisfeito);" title="Satisfeito/Produtivo"></label>
                        <input type="radio" name="humor_cor" id="m3" value="mediano" {% if not editando %}checked{% endif %} {% if editando and entrada.humor_cor == 'mediano' %}checked{% endif %}>
                        <label for="m3" style="background-color: var(--mood-mediano);" title="Mediano"></label>
                        <input type="radio" name="humor_cor" id="m4" value="doente" {% if editando and entrada.humor_cor == 'doente' %}checked{% endif %}>
                        <label for="m4" style="background-color: var(--mood-doente);" title="Doente/Cansado"></label>
                        <input type="radio" name="humor_cor" id="m5" value="ansioso" {% if editando and entrada.humor_cor == 'ansioso' %}checked{% endif %}>
                        <label for="m5" style="background-color: var(--mood-ansioso);" title="Ansioso/Pensativo"></label>
                        <input type="radio" name="humor_cor" id="m6" value="triste" {% if editando and entrada.humor_cor == 'triste' %}checked{% endif %}>
                        <label for="m6" style="background-color: var(--mood-triste);" title="Triste"></label>
                    </div>
                </div>

                <div class="mb-4 p-3 bg-light rounded-3">
                    <label class="form-label fw-bold small text-muted"><i class="fas fa-folder-open"></i> GUARDAR NO ÁLBUM</label>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <select name="tag_existente" class="form-select">
                                <option value="" selected>Sem Álbum</option>
                                {% for tag in sidebar_tags %}
                                    <option value="{{ tag.id }}" {% if editando and entrada.tag_id == tag.id %}selected{% endif %}>{{ tag.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" name="nova_tag" class="form-control" placeholder="Ou crie um novo...">
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted">TRILHA SONORA</label>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <input type="text" name="musica" class="form-control" placeholder="Nome da Música" value="{{ entrada.musica_dia if editando else '' }}">
                        </div>
                        <div class="col-md-7">
                            <input type="text" name="link_musica" id="link_input" class="form-control" placeholder="Link (YouTube, Spotify...)" value="{{ entrada.link_musica if editando else '' }}">
                        </div>
                    </div>
                    <div class="mt-3 d-flex align-items-center gap-3">
                        <img id="album-preview" src="" alt="Capa">
                        <span id="preview-text" class="small text-muted fst-italic">Cole um link do YouTube para ver a capa.</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted">QUERIDO DIÁRIO...</label>
                    <textarea name="descricao" class="form-control" rows="8" required style="resize:none;">{{ entrada.descricao if editando else '' }}</textarea>
                </div>

                <button type="submit" class="btn btn-custom w-100 py-3">Salvar Página</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Script para detectar link do YouTube e mostrar thumbnail
    const linkInput = document.getElementById('link_input');
    const previewImg = document.getElementById('album-preview');
    const previewText = document.getElementById('preview-text');

    function checkLink() {
        const url = linkInput.value;
        // Regex simples para pegar ID do Youtube
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);

        if (match && match[2].length === 11) {
            const videoId = match[2];
            previewImg.src = `https://img.youtube.com/vi/${videoId}/0.jpg`;
            previewImg.style.display = 'block';
            previewText.textContent = "Capa detectada!";
        } else {
            previewImg.style.display = 'none';
            previewText.textContent = url ? "Link salvo (sem capa automática)." : "Cole um link do YouTube para ver a capa.";
        }
    }

    linkInput.addEventListener('input', checkLink);
    // Roda ao carregar (se for edição)
    if(linkInput.value) checkLink();
</script>
{% endblock %}